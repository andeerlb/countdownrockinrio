pipeline {
    agent any 
    tools {nodejs "NodeLatest"}

    environment {
        CLOUDFRONT_ID = "E165NDOJ0Q86CD"
        AWS_ACCESS_KEY_ID     = credentials('aws_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')
    }

    stages {
        stage('Dependencies') { 
            steps {
                sh """
                    aws --version
                    node --version
                    yarn --version
                """
            }
        }

        stage("Build") {
            steps {
                sh """
                    yarn install
                    yarn build
                """
            }
        }

        stage("Deploy") {
            steps {
                sh """
                    aws s3 sync build/ s3://countdownrockinrio-web
                    aws cloudfront create-invalidation \
                        --distribution-id $CLOUDFRONT_ID \
                        --paths "/*"

                    CLOUDFRONT_INVALIDATION_ID=\\$(aws cloudfront create-invalidation --distribution-id E165NDOJ0Q86CD --paths /\\* | jq ".Invalidation.Id")

                    attempt_counter=0
                    max_attempts=5

                    waitForCompleted () {
                        while IFS=read -r line
                        do
                            CLOUDFRONT_INVALIDATION_STATUS=$(aws cloudfront get-invalidation --id I29G7388Z3WN7F --distribution-id E165NDOJ0Q86CD | jq ".Invalidation.Status")

                            if [[ CLOUDFRONT_INVALIDATION_STATUS -eq "Completed" ]]; then
                                break
                            fi

                            echo "$CLOUDFRONT_INVALIDATION_STATUS"
                            echo "Retry"
                        done
                    } <<(timeout 1s cat /dev/urandom && exit 1)

                    waitForCompleted
                """
            }
        }
    }
}